<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Switch</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* --- DARK NEON THEME --- */
        :root {
            --bg-deep: #050508;
            --neon-blue: #00F0FF;
            --neon-pink: #FF2E93;
            --neon-green: #39FF14;
            --neon-yellow: #FFD300;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            color: #fff;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: none;
            cursor: pointer;
        }

        #gameCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        .header-bar {
            margin-left: 100px;
            padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .score-display { font-size: 1.2rem; color: var(--neon-blue); }
        .speed-display { font-size: 0.8rem; color: var(--neon-green); }

        /* --- MENUS --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.9); backdrop-filter: blur(5px); z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 25px; pointer-events: auto; cursor: default;
        }

        h1 {
            font-size: 2.5rem; text-align: center; color: var(--neon-blue);
            text-shadow: 4px 4px 0px var(--neon-pink); line-height: 1.5; margin-bottom: 10px;
            transform: skew(-10deg);
        }

        .btn-retro {
            background: transparent; color: var(--neon-green); font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem; padding: 20px 40px; border: 4px solid var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green), inset 0 0 20px var(--neon-green);
            cursor: pointer; text-transform: uppercase; animation: pulse 1.5s infinite;
            z-index: 50; /* Ensure it's on top */
        }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .settings-row { display: flex; gap: 20px; margin-top: 10px; }
        .toggle-btn {
            background: transparent; border: 2px solid #666; color: #666; padding: 15px;
            cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 0.7rem;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
            z-index: 50;
        }
        .toggle-btn.active { border-color: var(--neon-yellow); color: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); }

        .controls-hint { color: #888; font-size: 0.7rem; text-align: center; line-height: 1.6; margin-top: 20px; }

        .back-home {
            position: absolute; top: 20px; left: 20px; text-decoration: none; color: #666; font-size: 0.8rem; z-index: 30; pointer-events: auto; cursor: pointer;
        }
        .back-home:hover { color: white; }

        /* --- LANDSCAPE LOCK (MOBILE ONLY) --- */
        #rotate-overlay {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #050508; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: var(--neon-pink);
        }

        .phone-icon {
            width: 80px; height: 140px;
            border: 4px solid var(--neon-pink);
            border-radius: 10px;
            margin-bottom: 20px;
            animation: rotatePhone 2s infinite ease-in-out;
        }

        @keyframes rotatePhone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }

        @media screen and (max-width: 900px) and (orientation: portrait) {
            #rotate-overlay { display: flex; }
            #gameCanvas, #ui-layer, #start-screen, .back-home { display: none !important; }
        }

    </style>
</head>
<body>

    <div id="rotate-overlay">
        <div class="phone-icon"></div>
        <p style="line-height: 1.5; font-size: 0.8rem;">PLEASE ROTATE<br>YOUR DEVICE</p>
    </div>

    <a href="../index.html" class="back-home">‚Üê EXIT</a>

    <div id="ui-layer">
        <div class="header-bar">
            <div class="score-display">DIST: <span id="score">0</span>m</div>
            <div class="speed-display">SPD: <span id="speed">100</span>%</div>
        </div>
    </div>

    <div id="start-screen">
        <h1 id="title-text">GRAVITY<br>SWITCH</h1>
        
        <button class="btn-retro" id="run-btn">RUN</button>
        
        <div class="settings-row">
            <button class="toggle-btn active" id="btn-sound">üîä SND</button>
            <button class="toggle-btn active" id="btn-haptic">üì≥ VIB</button>
        </div>

        <div class="controls-hint">
            TAP SCREEN / CLICK MOUSE<br>TO FLIP GRAVITY
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- 1. INITIALIZATION ORDER IS CRITICAL ---
        
        // Prevent context menu
        window.addEventListener('contextmenu', e => e.preventDefault());
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Define Globals First
        let width, height;
        let player = null;
        let audioCtx = null;
        let obstacles = []; 
        let particles = []; 
        let stars = [];
        let animationId;

        const settings = { sound: true, haptic: true };
        
        const state = {
            running: false, 
            score: 0, 
            speed: 8, 
            gravity: 1, 
            frame: 0, 
            groundY: 0, 
            ceilY: 0
        };

        // --- 2. RESIZE HANDLER ---
        function resize() { 
            width = canvas.width = window.innerWidth; 
            height = canvas.height = window.innerHeight;
            
            state.groundY = height - 50;
            state.ceilY = 50;

            if(player) {
                if(player.y > state.groundY - player.size) player.y = state.groundY - player.size;
                if(player.y < state.ceilY) player.y = state.ceilY;
            }
        }
        window.addEventListener('resize', resize);
        
        // Call resize NOW to set initial state
        resize();

        // Initialize Stars
        for(let i=0; i<80; i++) stars.push({x: Math.random()*width, y: Math.random()*height, size: Math.random()*2, speed: Math.random()*15+5});

        // --- 3. AUDIO SYSTEM ---
        function initAudio() { 
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
            if(audioCtx.state === 'suspended') audioCtx.resume(); 
        }
        
        function toggleSetting(key) {
            settings[key] = !settings[key];
            const btn = document.getElementById(key === 'sound' ? 'btn-sound' : 'btn-haptic');
            if(settings[key]) { 
                btn.classList.add('active'); 
                if(key==='sound') playTone(400,'sine',0.1); 
                if(key==='haptic') vibrate(50); 
            } else {
                btn.classList.remove('active');
            }
        }
        
        function vibrate(ms) { if(settings.haptic && navigator.vibrate) navigator.vibrate(ms); }
        
        function playTone(freq, type, dur, slide = false) {
            if(!settings.sound || !audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if(slide) osc.frequency.exponentialRampToValueAtTime(freq*2, audioCtx.currentTime + dur);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        function playFlipSound() { playTone(300, 'square', 0.15, true); }
        function playCrashSound() { playTone(100, 'sawtooth', 0.4); }

        // --- 4. GAME CLASSES ---
        class Player {
            constructor() {
                this.size = 40; this.x = 100; this.y = height - 100; 
                this.vy = 0; this.grounded = false; this.color = '#00F0FF'; this.trail = [];
            }
            flip() {
                if(this.grounded) {
                    state.gravity *= -1; this.grounded = false; this.vy = state.gravity * 5;
                    playFlipSound(); vibrate(30);
                    createExplosion(this.x, this.y, this.color, 5);
                }
            }
            update() {
                const gForce = 1.5; this.vy += state.gravity * gForce; this.y += this.vy;
                if(this.y >= state.groundY - this.size) {
                    this.y = state.groundY - this.size; this.vy = 0;
                    if(!this.grounded && state.gravity === 1) { this.grounded = true; vibrate(10); }
                }
                if(this.y <= state.ceilY) {
                    this.y = state.ceilY; this.vy = 0;
                    if(!this.grounded && state.gravity === -1) { this.grounded = true; vibrate(10); }
                }
                if(state.frame % 3 === 0) {
                    this.trail.push({x: this.x, y: this.y, alpha: 1.0});
                    if(this.trail.length > 10) this.trail.shift();
                }
            }
            draw() {
                this.trail.forEach(t => {
                    t.x -= state.speed; t.alpha -= 0.1;
                    ctx.fillStyle = `rgba(0, 240, 255, ${t.alpha})`; ctx.fillRect(t.x, t.y, this.size, this.size);
                });
                ctx.fillStyle = this.color; ctx.shadowBlur = 20; ctx.shadowColor = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.fillStyle = '#fff'; ctx.fillRect(this.x + 10, this.y + 10, this.size - 20, this.size - 20); ctx.shadowBlur = 0;
            }
        }

        class Obstacle {
            constructor() {
                this.w = 40; this.h = 60; this.x = width;
                this.onCeiling = Math.random() > 0.5;
                if(this.onCeiling) { this.y = state.ceilY; this.color = '#FF2E93'; } 
                else { this.y = state.groundY - this.h; this.color = '#39FF14'; }
            }
            update() { this.x -= state.speed; }
            draw() {
                ctx.fillStyle = this.color; ctx.shadowBlur = 10; ctx.shadowColor = this.color;
                ctx.beginPath();
                if(this.onCeiling) {
                    ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.w, this.y); ctx.lineTo(this.x + this.w/2, this.y + this.h);
                } else {
                    ctx.moveTo(this.x, this.y + this.h); ctx.lineTo(this.x + this.w, this.y + this.h); ctx.lineTo(this.x + this.w/2, this.y);
                }
                ctx.fill(); ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10; this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
            draw() { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0; }
        }

        // --- 5. CORE FUNCTIONS ---
        function startGame() {
            initAudio();
            state.running = true; state.score = 0; state.speed = 8; state.gravity = 1; state.frame = 0;
            player = new Player(); obstacles = []; particles = [];
            document.getElementById('start-screen').style.display = 'none';
            loop();
        }

        function gameOver() {
            state.running = false; playCrashSound(); vibrate(300);
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('title-text').innerHTML = `CRASHED!<br><span style="font-size:1.2rem; color:#fff">DIST: ${Math.floor(state.score)}m</span>`;
            document.getElementById('run-btn').innerText = "RETRY";
        }

        function checkCollision() {
            const p = player;
            const hitbox = {x: p.x + 5, y: p.y + 5, w: p.size - 10, h: p.size - 10};
            for(let o of obstacles) {
                if(hitbox.x < o.x + o.w && hitbox.x + hitbox.w > o.x && hitbox.y < o.y + o.h && hitbox.y + hitbox.h > o.y) {
                    createExplosion(p.x + p.size/2, p.y + p.size/2, p.color, 20); return true;
                }
            }
            return false;
        }

        function createExplosion(x, y, color, count) { for(let i=0; i<count; i++) particles.push(new Particle(x, y, color)); }

        function loop() {
            if(!state.running) return;
            ctx.fillStyle = '#050508'; ctx.fillRect(0, 0, width, height);

            ctx.fillStyle = '#fff'; stars.forEach(s => {
                s.x -= s.speed + (state.speed * 0.5); if(s.x < 0) { s.x = width; s.y = Math.random() * height; }
                ctx.globalAlpha = 0.3; ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x + s.speed*3, s.y); ctx.strokeStyle = '#fff'; ctx.lineWidth = s.size; ctx.stroke();
            }); ctx.globalAlpha = 1.0;

            ctx.shadowBlur = 10; ctx.shadowColor = '#00F0FF'; ctx.strokeStyle = '#00F0FF'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, state.ceilY); ctx.lineTo(width, state.ceilY); ctx.stroke();
            ctx.shadowColor = '#FF2E93'; ctx.strokeStyle = '#FF2E93';
            ctx.beginPath(); ctx.moveTo(0, state.groundY); ctx.lineTo(width, state.groundY); ctx.stroke(); ctx.shadowBlur = 0;

            player.update(); player.draw();

            let spawnFreq = Math.max(30, 100 - Math.floor(state.score / 50));
            if(state.frame % spawnFreq === 0) obstacles.push(new Obstacle());

            obstacles.forEach(o => { o.update(); o.draw(); }); obstacles = obstacles.filter(o => o.x > -100);
            particles.forEach(p => { p.update(); p.draw(); }); particles = particles.filter(p => p.life > 0);

            if(checkCollision()) { gameOver(); return; }

            state.score += (state.speed / 20); document.getElementById('score').innerText = Math.floor(state.score);
            if(state.speed < 20) state.speed += 0.005; document.getElementById('speed').innerText = Math.floor((state.speed / 8) * 100);

            state.frame++; requestAnimationFrame(loop);
        }

        // --- 6. EVENT LISTENERS ---
        
        // Buttons
        document.getElementById('run-btn').addEventListener('click', startGame);
        document.getElementById('btn-sound').addEventListener('click', () => toggleSetting('sound'));
        document.getElementById('btn-haptic').addEventListener('click', () => toggleSetting('haptic'));

        // Gameplay Input
        window.addEventListener('mousedown', (e) => {
            if(state.running) player.flip();
        });
        
        window.addEventListener('keydown', (e) => {
            if(state.running && e.code === 'Space') player.flip();
        });

        // Touch - CAREFUL LOGIC
        window.addEventListener('touchstart', (e) => {
            if(state.running) {
                // If game is running, ALL touches flip gravity and prevent scrolling
                e.preventDefault();
                player.flip();
            }
            // If game is NOT running (Menu), we DO NOT prevent default, 
            // so buttons can receive their clicks naturally.
        }, {passive: false});

    </script>
    
</body>
</html>